<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤šäººå”ä½œæ–‡ä»¶ç°½ç½²å·¥å…· (é«˜ç•«è³ªç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8' }
                    }
                }
            }
        }
    </script>
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        #signature-pad { touch-action: none; cursor: crosshair; }
        .dragging {
            cursor: move;
            border: 2px dashed #3b82f6;
            background: rgba(59, 130, 246, 0.1);
            z-index: 1000;
            user-select: none;
        }
        .resize-handle {
            width: 12px;
            height: 12px;
            background-color: #3b82f6;
            border: 2px solid white;
            position: absolute;
            right: -6px;
            bottom: -6px;
            cursor: nwse-resize;
            border-radius: 50%;
            z-index: 1001;
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex; align-items: center; justify-content: center;
            z-index: 50; backdrop-filter: blur(2px);
        }
        .color-radio:checked + label { ring-width: 2px; ring-offset-width: 2px; transform: scale(1.1); }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 flex flex-col items-center min-h-screen p-4 md:p-6">

    <div class="w-full max-w-6xl bg-white rounded-xl shadow-xl overflow-hidden flex flex-col md:flex-row min-h-[80vh]">
        
        <!-- å·¦å´é¢æ¿ï¼šæ§åˆ¶å€ -->
        <aside class="w-full md:w-80 bg-gray-50 border-r border-gray-200 flex-shrink-0 flex flex-col">
            <div class="p-6 border-b border-gray-200">
                <h1 class="text-2xl font-bold text-gray-900 flex items-center gap-2">
                    <svg class="w-8 h-8 text-brand-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                    æ–‡ä»¶ç°½ç½²é€š
                </h1>
                <p class="text-xs text-gray-500 mt-1">é«˜ç•«è³ªè¼¸å‡ºç‰ˆæœ¬</p>
            </div>

            <!-- è¼‰å…¥ä¸­ -->
            <div id="loader" class="flex-1 flex flex-col items-center justify-center p-6 space-y-4 hidden">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-brand-600"></div>
                <p class="text-sm text-gray-500">è™•ç†ä¸­...</p>
            </div>

            <!-- ç‹€æ…‹ï¼šå»ºç«‹æ–°æˆ¿é–“ -->
            <div id="create-view" class="flex-1 p-6 flex flex-col justify-center space-y-6">
                <div>
                    <h2 class="text-lg font-bold mb-2">æ­¥é©Ÿ 1: ä¸Šå‚³æ–‡ä»¶</h2>
                    <p class="text-sm text-gray-500 mb-4">æ”¯æ´ JPG, PNG æˆ– PDF</p>
                    
                    <input type="file" id="file-uploader" accept="image/png, image/jpeg, application/pdf" class="hidden">
                    <button onclick="document.getElementById('file-uploader').click()" class="w-full border-2 border-dashed border-gray-300 rounded-lg p-6 hover:border-brand-500 hover:bg-brand-50 transition-colors text-center group">
                        <svg class="w-8 h-8 mx-auto text-gray-400 group-hover:text-brand-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                        <span class="text-sm font-medium text-gray-600 group-hover:text-brand-600">é»æ“Šé¸æ“‡æª”æ¡ˆ</span>
                    </button>
                    <p id="file-name" class="mt-2 text-xs text-brand-600 font-medium truncate"></p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">æˆªæ­¢æ™‚é–“ (é¸å¡«)</label>
                    <input type="datetime-local" id="deadline-input" class="w-full p-2 border border-gray-300 rounded-md text-sm focus:ring-2 focus:ring-brand-500 focus:outline-none">
                </div>

                <button id="create-room-btn" class="w-full bg-brand-600 text-white font-bold py-3 rounded-lg hover:bg-brand-700 transition-all shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                    å»ºç«‹ç°½ç½²ç©ºé–“
                </button>
            </div>

            <!-- ç‹€æ…‹ï¼šæˆ¿é–“å…§æ“ä½œ -->
            <div id="room-controls" class="flex-1 p-6 flex flex-col hidden overflow-y-auto">
                <!-- åˆ†äº«å€å¡Š -->
                <div class="bg-blue-50 p-3 rounded-lg mb-6 border border-blue-100">
                    <h3 class="text-xs font-bold text-blue-800 uppercase tracking-wide mb-2">é‚€è«‹é€£çµ</h3>
                    <div class="flex gap-1">
                        <input type="text" id="share-link" readonly class="flex-1 bg-white border border-blue-200 rounded px-2 py-1 text-xs text-gray-600">
                        <button id="copy-link-btn" class="bg-blue-600 text-white px-3 py-1 rounded text-xs hover:bg-blue-700">è¤‡è£½</button>
                    </div>
                    <p id="deadline-info" class="text-xs text-red-500 mt-2 font-medium hidden">æˆªæ­¢ï¼š<span id="deadline-display"></span></p>
                </div>

                <!-- å·¥å…·åˆ— -->
                <div class="space-y-3 mb-6">
                    <h3 class="text-sm font-bold text-gray-700">æ–°å¢é …ç›®</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button id="btn-add-sig" class="flex items-center justify-center gap-2 bg-white border border-gray-300 p-2 rounded hover:bg-gray-50 hover:border-gray-400 transition-colors">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                            <span class="text-sm">ç°½å</span>
                        </button>
                        <button id="btn-add-text" class="flex items-center justify-center gap-2 bg-white border border-gray-300 p-2 rounded hover:bg-gray-50 hover:border-gray-400 transition-colors">
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 8h10M7 12h4m1 8l-4-4H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-3l-4 4z"></path></svg>
                            <span class="text-sm">æ–‡å­—</span>
                        </button>
                    </div>
                    <p id="drag-hint" class="text-xs text-amber-600 bg-amber-50 p-2 rounded border border-amber-100 hidden">
                        ğŸ‘† é»æ“Šæ–‡ä»¶ä¸Šçš„ç‰©ä»¶å³å¯ç§»å‹•ã€ç¸®æ”¾æˆ–åˆªé™¤ã€‚<br>
                        <span class="text-xs text-gray-500 mt-1 block">ç™¼èµ·äººå¯èª¿æ•´æ‰€æœ‰ç‰©ä»¶ã€‚</span>
                    </p>
                </div>

                <!-- æˆ‘çš„é …ç›®åˆ—è¡¨ -->
                <div class="flex-1 overflow-y-auto min-h-[100px]">
                    <h3 class="text-sm font-bold text-gray-700 mb-2">æˆ‘åŠ å…¥çš„å…§å®¹</h3>
                    <ul id="my-items-list" class="space-y-2">
                        <!-- JS å‹•æ…‹ç”¢ç”Ÿ -->
                        <li class="text-xs text-gray-400 italic text-center py-4">å°šæœªåŠ å…¥ä»»ä½•é …ç›®</li>
                    </ul>
                </div>

                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button id="download-btn" class="w-full bg-green-600 text-white font-bold py-2 rounded hover:bg-green-700 transition-colors flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                        ä¸‹è¼‰ç°½ç½²æ–‡ä»¶
                    </button>
                </div>
            </div>
        </aside>

        <!-- å³å´é¢æ¿ï¼šæ–‡ä»¶é¡¯ç¤ºå€ -->
        <main class="flex-1 bg-gray-200 relative overflow-auto flex items-center justify-center p-4">
            <div id="document-container" class="relative bg-white shadow-lg mx-auto select-none">
                <canvas id="document-canvas" class="block cursor-pointer"></canvas>
            </div>
        </main>
    </div>

    <!-- ç°½åæ¿ Modal (åŒå‰) -->
    <div id="signature-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">ç¹ªè£½ç°½å</h3>
                <button class="modal-close text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex items-center justify-between mb-3 bg-gray-50 p-2 rounded-lg">
                <div class="flex space-x-3">
                    <div class="relative">
                        <input type="radio" name="pen-color" id="color-black" value="#000000" class="color-radio sr-only" checked>
                        <label for="color-black" class="block w-6 h-6 rounded-full bg-black cursor-pointer ring-offset-2 ring-gray-300"></label>
                    </div>
                    <div class="relative">
                        <input type="radio" name="pen-color" id="color-blue" value="#0000FF" class="color-radio sr-only">
                        <label for="color-blue" class="block w-6 h-6 rounded-full bg-blue-600 cursor-pointer ring-blue-300"></label>
                    </div>
                    <div class="relative">
                        <input type="radio" name="pen-color" id="color-red" value="#FF0000" class="color-radio sr-only">
                        <label for="color-red" class="block w-6 h-6 rounded-full bg-red-600 cursor-pointer ring-red-300"></label>
                    </div>
                </div>
                <div class="flex items-center space-x-2">
                    <span class="text-xs text-gray-500">ç²—ç´°</span>
                    <input type="range" id="pen-width" min="1" max="5" value="2" class="w-20 accent-brand-600">
                </div>
            </div>

            <div class="bg-white border-2 border-gray-200 rounded-lg touch-none">
                 <canvas id="signature-pad" class="w-full h-48 rounded-md"></canvas>
            </div>
            <p id="signature-error" class="text-red-500 text-sm mt-2 text-center hidden">è«‹å…ˆç°½å</p>
            
            <div class="flex gap-3 mt-5">
                <button id="clear-signature" class="flex-1 bg-gray-100 text-gray-700 font-semibold py-2 px-4 rounded-lg hover:bg-gray-200">æ¸…é™¤</button>
                <button id="confirm-signature" class="flex-1 bg-brand-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-brand-700">ç¢ºèªä½¿ç”¨</button>
            </div>
        </div>
    </div>

    <!-- æ–‡å­—è¼¸å…¥ Modal (åŒå‰) -->
    <div id="text-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm mx-4">
             <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">æ’å…¥æ–‡å­—</h3>
                <button class="modal-close text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <input type="text" id="text-content" placeholder="è«‹è¼¸å…¥å…§å®¹ (ä¾‹å¦‚: å§“åã€æ—¥æœŸ)" class="w-full border border-gray-300 rounded-lg p-3 mb-4 focus:ring-2 focus:ring-brand-500 focus:outline-none">
            
            <div class="flex items-center justify-between mb-4">
                <div class="flex space-x-2">
                    <button class="text-color-btn w-6 h-6 rounded-full bg-black ring-2 ring-offset-1 ring-transparent hover:scale-110 transition-transform" data-color="#000000"></button>
                    <button class="text-color-btn w-6 h-6 rounded-full bg-blue-600 hover:scale-110 transition-transform" data-color="#0000FF"></button>
                    <button class="text-color-btn w-6 h-6 rounded-full bg-red-600 hover:scale-110 transition-transform" data-color="#FF0000"></button>
                </div>
                <select id="text-size" class="border border-gray-300 rounded px-2 py-1 text-sm">
                    <option value="16">å°</option>
                    <option value="24" selected>ä¸­</option>
                    <option value="36">å¤§</option>
                    <option value="48">ç‰¹å¤§</option>
                </select>
            </div>

            <button id="confirm-text" class="w-full bg-brand-600 text-white font-bold py-2 rounded-lg hover:bg-brand-700">åŠ å…¥æ–‡ä»¶</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, onSnapshot, collection, serverTimestamp, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            // è«‹å°‡æ­¤è™•æ›¿æ›å›æ‚¨è‡ªå·±çš„è¨­å®š (ä»¥ä¸‹ç‚ºé è¨­æ¸¬è©¦ç”¨)
            apiKey: "AIzaSyACheuw4QDEnXbTFduwaXFLIujXBHFhV-Q",
  authDomain: "esignature-987ac.firebaseapp.com",
  projectId: "esignature-987ac",
  storageBucket: "esignature-987ac.firebasestorage.app",
  messagingSenderId: "56174346940",
  appId: "1:56174346940:web:8f8a664b84109fa849c6b9",
  measurementId: "G-GDYR4F5ZD9"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.worker.min.js`;

        let currentUser = null;
        let currentRoomId = null;
        let initiatorId = null;
        let originalImage = new Image();
        let roomDeadline = null;
        let currentItems = []; 
        let unsubscribe = null;
        let editingItemId = null;

        const els = {
            loader: document.getElementById('loader'),
            createView: document.getElementById('create-view'),
            roomControls: document.getElementById('room-controls'),
            fileUploader: document.getElementById('file-uploader'),
            fileName: document.getElementById('file-name'),
            createBtn: document.getElementById('create-room-btn'),
            deadlineInput: document.getElementById('deadline-input'),
            docContainer: document.getElementById('document-container'),
            docCanvas: document.getElementById('document-canvas'),
            shareLink: document.getElementById('share-link'),
            myItemsList: document.getElementById('my-items-list'),
            dragHint: document.getElementById('drag-hint'),
            sigModal: document.getElementById('signature-modal'),
            textModal: document.getElementById('text-modal'),
            sigPad: document.getElementById('signature-pad'),
        };

        const ctx = els.docCanvas.getContext('2d');
        const sigCtx = els.sigPad.getContext('2d');
        let selectedTextColor = '#000000';

        document.addEventListener('DOMContentLoaded', () => {
            onAuthStateChanged(auth, async (user) => {
                if (user) { currentUser = user; handleRouting(); } 
                else { await signInAnonymously(auth); }
            });

            els.fileUploader.addEventListener('change', handleFileSelect);
            els.createBtn.onclick = createRoom;
            document.getElementById('copy-link-btn').onclick = copyShareLink;
            document.getElementById('download-btn').onclick = downloadHighResDocument; // æ›´æ”¹ä¸‹è¼‰é‚è¼¯
            
            document.getElementById('btn-add-sig').onclick = () => checkDeadline() && openSigModal();
            document.getElementById('btn-add-text').onclick = () => checkDeadline() && openTextModal();
            document.querySelectorAll('.modal-close').forEach(btn => btn.onclick = closeModals);
            
            document.getElementById('clear-signature').onclick = clearSigPad;
            document.getElementById('confirm-signature').onclick = confirmSignature;
            document.querySelectorAll('input[name="pen-color"]').forEach(r => r.addEventListener('change', (e) => {
                sigCtx.strokeStyle = e.target.value;
            }));
            document.getElementById('pen-width').addEventListener('input', (e) => {
                sigCtx.lineWidth = e.target.value;
            });

            document.getElementById('confirm-text').onclick = confirmText;
            document.querySelectorAll('.text-color-btn').forEach(btn => btn.onclick = (e) => {
                document.querySelectorAll('.text-color-btn').forEach(b => b.classList.remove('ring-2', 'ring-offset-1', 'ring-transparent'));
                e.target.classList.add('ring-2', 'ring-offset-1', 'ring-transparent');
                selectedTextColor = e.target.dataset.color;
            });
            
            window.addEventListener('resize', resizeCanvas);
            
            els.docCanvas.addEventListener('mousedown', handleCanvasClick);
            els.docCanvas.addEventListener('touchstart', handleCanvasClick);
        });

        function handleRouting() {
            const params = new URLSearchParams(window.location.search);
            currentRoomId = params.get('room');
            
            els.loader.classList.add('hidden');
            if (currentRoomId) {
                els.createView.classList.add('hidden');
                els.roomControls.classList.remove('hidden');
                loadRoom(currentRoomId);
            } else {
                els.createView.classList.remove('hidden');
                els.roomControls.classList.add('hidden');
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if(file) {
                els.fileName.textContent = file.name;
                els.createBtn.disabled = false;
            } else {
                els.fileName.textContent = '';
                els.createBtn.disabled = true;
            }
        }

        async function createRoom() {
            const file = els.fileUploader.files[0];
            if (!file) return;

            els.createBtn.disabled = true;
            els.createBtn.textContent = 'è™•ç†ä¸­...';

            try {
                let imageDataUrl;
                if (file.type === "application/pdf") {
                    imageDataUrl = await renderPdfToImage(file);
                } else {
                    imageDataUrl = await readFileAsDataURL(file);
                }

                const roomData = {
                    initiatorId: currentUser.uid,
                    originalImage: imageDataUrl,
                    createdAt: serverTimestamp(),
                    deadline: els.deadlineInput.value ? new Date(els.deadlineInput.value) : null
                };

                const docRef = await addDoc(collection(db, 'signing_rooms'), roomData);
                window.location.search = `?room=${docRef.id}`;
            } catch (err) {
                console.error(err);
                alert('å»ºç«‹å¤±æ•—ï¼Œè«‹é‡è©¦');
                els.createBtn.disabled = false;
            }
        }

        async function loadRoom(roomId) {
            els.loader.classList.remove('hidden');
            const roomSnap = await getDoc(doc(db, 'signing_rooms', roomId));
            
            if (!roomSnap.exists()) {
                alert('æˆ¿é–“ä¸å­˜åœ¨');
                window.location.href = '/';
                return;
            }

            const data = roomSnap.data();
            initiatorId = data.initiatorId;
            originalImage.src = data.originalImage;
            
            if (data.deadline) {
                roomDeadline = data.deadline.toDate();
                document.getElementById('deadline-info').classList.remove('hidden');
                document.getElementById('deadline-display').textContent = roomDeadline.toLocaleString();
                checkDeadline();
            }

            originalImage.onload = () => {
                els.loader.classList.add('hidden');
                resizeCanvas();
                setupRealtimeListener(roomId);
                els.dragHint.classList.remove('hidden');
            };
            
            els.shareLink.value = window.location.href;
        }

        function checkDeadline() {
            if (roomDeadline && new Date() > roomDeadline) {
                alert('æ­¤æ–‡ä»¶ç°½ç½²æ™‚é–“å·²æˆªæ­¢ï¼Œç„¡æ³•æ–°å¢æˆ–ä¿®æ”¹å…§å®¹ã€‚');
                document.getElementById('btn-add-sig').disabled = true;
                document.getElementById('btn-add-text').disabled = true;
                return false;
            }
            return true;
        }

        function setupRealtimeListener(roomId) {
            const q = query(collection(db, `signing_rooms/${roomId}/items`), orderBy('createdAt', 'asc'));
            
            if (unsubscribe) unsubscribe();
            unsubscribe = onSnapshot(q, (snapshot) => {
                currentItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateMyItemsList();
                redrawCanvas();
            });
        }

        // --- Canvas é¡¯ç¤ºèˆ‡äº’å‹• ---

        function resizeCanvas() {
            if (!originalImage.src) return;
            // è®“è¢å¹•ä¸Šçš„ Canvas å¯¬åº¦è·Ÿéš¨å®¹å™¨ï¼Œä½†ç•«è³ªè§£æåº¦è·Ÿéš¨è¢å¹•
            const containerWidth = els.docContainer.clientWidth;
            const finalWidth = Math.min(containerWidth, originalImage.width); 
            const scale = finalWidth / originalImage.width;
            
            els.docCanvas.width = finalWidth;
            els.docCanvas.height = originalImage.height * scale;
            els.docCanvas.style.width = `${finalWidth}px`;
            els.docCanvas.style.height = `${els.docCanvas.height}px`;

            redrawCanvas();
        }

        function redrawCanvas() {
            if (els.docCanvas.width === 0) return;
            ctx.clearRect(0, 0, els.docCanvas.width, els.docCanvas.height);
            ctx.drawImage(originalImage, 0, 0, els.docCanvas.width, els.docCanvas.height);

            currentItems.forEach(item => {
                if (item.id === editingItemId) return;

                const x = item.x_percent * els.docCanvas.width;
                const y = item.y_percent * els.docCanvas.height;
                const w = item.width_percent * els.docCanvas.width;

                if (item.type === 'signature') {
                    const img = new Image();
                    img.src = item.content;
                    ctx.drawImage(img, x, y, w, (w/img.width)*img.height);
                } else if (item.type === 'text') {
                    const fontSize = item.size_percent * els.docCanvas.width; 
                    ctx.font = `bold ${fontSize}px "Noto Sans TC", sans-serif`;
                    ctx.fillStyle = item.color || '#000000';
                    ctx.textBaseline = 'top';
                    ctx.fillText(item.content, x, y);
                }
            });
        }

        function handleCanvasClick(e) {
            if (editingItemId) return;
            if (!checkDeadline()) return;

            e.preventDefault();
            const rect = els.docCanvas.getBoundingClientRect();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            const x = clientX - rect.left;
            const y = clientY - rect.top;

            for (let i = currentItems.length - 1; i >= 0; i--) {
                const item = currentItems[i];
                const isOwner = item.signerId === currentUser.uid;
                const isInitiator = currentUser.uid === initiatorId;
                
                if (!isOwner && !isInitiator) continue;

                if (hitTest(x, y, item)) {
                    openItemEditor(item);
                    break;
                }
            }
        }

        function hitTest(mouseX, mouseY, item) {
            const x = item.x_percent * els.docCanvas.width;
            const y = item.y_percent * els.docCanvas.height;
            let w, h;

            if (item.type === 'signature') {
                w = item.width_percent * els.docCanvas.width;
                h = w * 0.5; 
            } else {
                const fontSize = item.size_percent * els.docCanvas.width;
                ctx.font = `bold ${fontSize}px "Noto Sans TC", sans-serif`;
                const metrics = ctx.measureText(item.content);
                w = metrics.width;
                h = fontSize;
            }

            return mouseX >= x && mouseX <= x + w && mouseY >= y && mouseY <= y + h;
        }

        // --- ç·¨è¼¯å™¨é‚è¼¯ ---

        function openItemEditor(item) {
            editingItemId = item.id;
            redrawCanvas();
            
            let content = item.content;
            let options = {
                color: item.color,
                currentWidth: item.width_percent ? item.width_percent * els.docCanvas.width : null,
                currentFontSize: item.size_percent ? item.size_percent * els.docCanvas.width : null,
                currentX: item.x_percent * els.docCanvas.width,
                currentY: item.y_percent * els.docCanvas.height
            };

            createEditorOverlay(item.type, content, options, item.id);
        }

        function createEditorOverlay(type, content, options = {}, existingId = null) {
            const wrapper = document.createElement('div');
            wrapper.className = 'absolute dragging group p-1 border-2 border-brand-500 border-dashed hover:border-solid';
            
            if (existingId) {
                wrapper.style.left = `${options.currentX}px`;
                wrapper.style.top = `${options.currentY}px`;
            } else {
                wrapper.style.left = '50%';
                wrapper.style.top = '50%';
                wrapper.style.transform = 'translate(-50%, -50%)';
            }

            const removeBtn = document.createElement('button');
            removeBtn.innerHTML = 'âœ•';
            removeBtn.className = 'absolute -top-3 -right-3 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-sm hover:bg-red-600 z-10 cursor-pointer';
            
            const confirmBtn = document.createElement('button');
            confirmBtn.innerHTML = 'âœ“';
            confirmBtn.className = 'absolute -bottom-3 -right-3 bg-green-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs font-bold shadow-sm hover:bg-green-600 z-10 cursor-pointer';

            const resizeHandle = document.createElement('div');
            resizeHandle.className = 'resize-handle';
            
            let contentEl;
            if (type === 'signature') {
                contentEl = document.createElement('img');
                contentEl.src = content;
                contentEl.className = 'pointer-events-none block';
                if (options.currentWidth) {
                    contentEl.style.width = `${options.currentWidth}px`;
                } else {
                    contentEl.style.width = '150px';
                }
            } else {
                contentEl = document.createElement('div');
                contentEl.textContent = content;
                contentEl.style.color = options.color;
                contentEl.style.fontWeight = 'bold';
                contentEl.className = 'whitespace-nowrap pointer-events-none font-sans leading-none';
                const size = options.currentFontSize || options.baseSize || 24;
                contentEl.style.fontSize = `${size}px`;
            }

            wrapper.appendChild(contentEl);
            wrapper.appendChild(removeBtn);
            wrapper.appendChild(confirmBtn);
            wrapper.appendChild(resizeHandle);
            els.docContainer.appendChild(wrapper);

            if (!existingId) {
                const rect = wrapper.getBoundingClientRect();
                const containerRect = els.docContainer.getBoundingClientRect();
                wrapper.style.transform = 'none';
                wrapper.style.left = `${(containerRect.width - rect.width) / 2}px`;
                wrapper.style.top = `${(containerRect.height - rect.height) / 3}px`;
            }

            let isDragging = false;
            let startX, startY, initialLeft, initialTop;

            const onMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                const clientX = e.clientX || e.touches[0].clientX;
                const clientY = e.clientY || e.touches[0].clientY;
                wrapper.style.left = `${initialLeft + (clientX - startX)}px`;
                wrapper.style.top = `${initialTop + (clientY - startY)}px`;
            };
            const onUp = () => isDragging = false;
            const onDown = (e) => {
                if(e.target === removeBtn || e.target === confirmBtn || e.target === resizeHandle) return;
                e.preventDefault();
                isDragging = true;
                startX = e.clientX || e.touches[0].clientX;
                startY = e.clientY || e.touches[0].clientY;
                initialLeft = wrapper.offsetLeft;
                initialTop = wrapper.offsetTop;
            };

            wrapper.addEventListener('mousedown', onDown);
            wrapper.addEventListener('touchstart', onDown);
            document.addEventListener('mousemove', onMove);
            document.addEventListener('touchmove', onMove);
            document.addEventListener('mouseup', onUp);
            document.addEventListener('touchend', onUp);

            let isResizing = false;
            let resizeStartX, resizeStartWidth, resizeStartFontSize;

            const onResizeMove = (e) => {
                if (!isResizing) return;
                e.preventDefault();
                e.stopPropagation();
                const clientX = e.clientX || e.touches[0].clientX;
                const dx = clientX - resizeStartX;

                if (type === 'signature') {
                    const newWidth = Math.max(50, resizeStartWidth + dx);
                    contentEl.style.width = `${newWidth}px`;
                } else {
                    const scaleFactor = 0.2;
                    const newSize = Math.max(12, resizeStartFontSize + dx * scaleFactor);
                    contentEl.style.fontSize = `${newSize}px`;
                }
            };
            const onResizeUp = () => isResizing = false;
            const onResizeDown = (e) => {
                e.preventDefault();
                e.stopPropagation();
                isResizing = true;
                resizeStartX = e.clientX || e.touches[0].clientX;
                if (type === 'signature') {
                    resizeStartWidth = contentEl.offsetWidth;
                } else {
                    resizeStartFontSize = parseFloat(window.getComputedStyle(contentEl).fontSize);
                }
            };

            resizeHandle.addEventListener('mousedown', onResizeDown);
            resizeHandle.addEventListener('touchstart', onResizeDown);
            document.addEventListener('mousemove', onResizeMove);
            document.addEventListener('touchmove', onResizeMove);
            document.addEventListener('mouseup', onResizeUp);
            document.addEventListener('touchend', onResizeUp);

            removeBtn.onclick = async (e) => {
                e.stopPropagation();
                if (existingId) {
                    if (confirm('ç¢ºå®šè¦åˆªé™¤å—ï¼Ÿ')) {
                        await deleteDoc(doc(db, `signing_rooms/${currentRoomId}/items`, existingId));
                    } else {
                        editingItemId = null;
                        redrawCanvas();
                    }
                }
                wrapper.remove();
                editingItemId = null;
            };

            confirmBtn.onclick = async (e) => {
                e.stopPropagation();
                const contentRect = contentEl.getBoundingClientRect();
                const x = wrapper.offsetLeft;
                const y = wrapper.offsetTop;
                
                const itemData = {
                    type: type,
                    content: content,
                    x_percent: x / els.docCanvas.width,
                    y_percent: y / els.docCanvas.height,
                    width_percent: contentRect.width / els.docCanvas.width,
                    size_percent: parseFloat(contentEl.style.fontSize) / els.docCanvas.width,
                    color: options.color || null,
                    signerId: existingId ? currentItems.find(i=>i.id===existingId).signerId : currentUser.uid,
                    createdAt: existingId ? currentItems.find(i=>i.id===existingId).createdAt : serverTimestamp()
                };

                wrapper.remove();
                editingItemId = null;

                if (existingId) {
                    await updateDoc(doc(db, `signing_rooms/${currentRoomId}/items`, existingId), itemData);
                } else {
                    await addDoc(collection(db, `signing_rooms/${currentRoomId}/items`), itemData);
                }
                redrawCanvas();
            };
        }

        function openSigModal() {
            els.sigModal.classList.remove('hidden');
            setupSigCanvas();
        }
        function openTextModal() {
            els.textModal.classList.remove('hidden');
            document.getElementById('text-content').value = '';
            document.getElementById('text-content').focus();
        }
        function closeModals() {
            els.sigModal.classList.add('hidden');
            els.textModal.classList.add('hidden');
        }

        function setupSigCanvas() {
            const rect = els.sigPad.getBoundingClientRect();
            els.sigPad.width = rect.width;
            els.sigPad.height = rect.height;
            sigCtx.lineCap = 'round';
            sigCtx.lineJoin = 'round';
            sigCtx.strokeStyle = document.querySelector('input[name="pen-color"]:checked').value;
            sigCtx.lineWidth = document.getElementById('pen-width').value;
        }

        function clearSigPad() {
            sigCtx.clearRect(0, 0, els.sigPad.width, els.sigPad.height);
        }

        function confirmSignature() {
            const pixelBuffer = sigCtx.getImageData(0, 0, els.sigPad.width, els.sigPad.height).data;
            if (!pixelBuffer.some(channel => channel !== 0)) {
                document.getElementById('signature-error').classList.remove('hidden');
                return;
            }
            document.getElementById('signature-error').classList.add('hidden');
            
            const dataUrl = els.sigPad.toDataURL('image/png');
            createEditorOverlay('signature', dataUrl);
            closeModals();
        }

        function confirmText() {
            const text = document.getElementById('text-content').value;
            if (!text.trim()) return;
            const size = document.getElementById('text-size').value;
            
            createEditorOverlay('text', text, {
                color: selectedTextColor,
                baseSize: parseInt(size)
            });
            closeModals();
        }

        let isDrawing = false, lastX = 0, lastY = 0;
        function getPointerPos(e) {
            const rect = els.sigPad.getBoundingClientRect();
            const clientX = e.clientX || e.touches[0].clientX;
            const clientY = e.clientY || e.touches[0].clientY;
            return { x: clientX - rect.left, y: clientY - rect.top };
        }
        ['mousedown', 'touchstart'].forEach(evt => els.sigPad.addEventListener(evt, (e) => {
            isDrawing = true; 
            const pos = getPointerPos(e); 
            [lastX, lastY] = [pos.x, pos.y];
            e.preventDefault();
        }, {passive: false}));
        ['mousemove', 'touchmove'].forEach(evt => els.sigPad.addEventListener(evt, (e) => {
            if (!isDrawing) return;
            e.preventDefault();
            const { x, y } = getPointerPos(e);
            sigCtx.beginPath();
            sigCtx.moveTo(lastX, lastY);
            sigCtx.lineTo(x, y);
            sigCtx.stroke();
            [lastX, lastY] = [x, y];
        }, {passive: false}));
        ['mouseup', 'touchend', 'mouseout'].forEach(evt => els.sigPad.addEventListener(evt, () => isDrawing = false));

        // --- å…¨æ–°åŠŸèƒ½ï¼šé«˜è§£æåº¦ä¸‹è¼‰é‚è¼¯ ---

        async function downloadHighResDocument() {
            if (editingItemId) {
                alert('è«‹å…ˆç¢ºèªæˆ–å–æ¶ˆç•¶å‰çš„ç·¨è¼¯é …ç›® (æ‰“å‹¾æˆ–åˆªé™¤)');
                return;
            }

            const downloadBtn = document.getElementById('download-btn');
            const originalText = downloadBtn.textContent;
            downloadBtn.textContent = 'ç”¢ç”Ÿé«˜ç•«è³ªåœ–ç‰‡ä¸­...';
            downloadBtn.disabled = true;

            // 1. å‰µå»ºä¸€å€‹æš«æ™‚çš„ Canvasï¼Œå°ºå¯¸ç‚ºåŸå§‹åœ–ç‰‡å°ºå¯¸ (é«˜è§£æåº¦)
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = originalImage.width;
            tempCanvas.height = originalImage.height;
            const tempCtx = tempCanvas.getContext('2d');

            // 2. ç¹ªè£½åº•åœ–
            tempCtx.drawImage(originalImage, 0, 0, tempCanvas.width, tempCanvas.height);

            // 3. ç¹ªè£½æ‰€æœ‰é …ç›® (éœ€è¦ç­‰å¾…åœ–ç‰‡è¼‰å…¥)
            const drawPromises = currentItems.map(item => {
                return new Promise((resolve) => {
                    const x = item.x_percent * tempCanvas.width;
                    const y = item.y_percent * tempCanvas.height;
                    const w = item.width_percent * tempCanvas.width;

                    if (item.type === 'signature') {
                        const img = new Image();
                        img.crossOrigin = "anonymous";
                        img.onload = () => {
                            tempCtx.drawImage(img, x, y, w, (w / img.width) * img.height);
                            resolve();
                        };
                        img.onerror = resolve; // é¿å…å–®ä¸€åœ–ç‰‡å¤±æ•—å¡æ­»
                        img.src = item.content;
                    } else if (item.type === 'text') {
                        const fontSize = item.size_percent * tempCanvas.width;
                        tempCtx.font = `bold ${fontSize}px "Noto Sans TC", sans-serif`;
                        tempCtx.fillStyle = item.color || '#000000';
                        tempCtx.textBaseline = 'top';
                        tempCtx.fillText(item.content, x, y);
                        resolve();
                    }
                });
            });

            await Promise.all(drawPromises);

            // 4. ä¸‹è¼‰
            const link = document.createElement('a');
            link.download = `signed-document-${currentRoomId}-highres.png`;
            link.href = tempCanvas.toDataURL('image/png');
            link.click();

            downloadBtn.textContent = originalText;
            downloadBtn.disabled = false;
        }

        function copyShareLink() {
            els.shareLink.select();
            document.execCommand('copy');
            const btn = document.getElementById('copy-link-btn');
            const originalText = btn.textContent;
            btn.textContent = 'å·²è¤‡è£½!';
            setTimeout(() => btn.textContent = originalText, 2000);
        }

        function updateMyItemsList() {
            els.myItemsList.innerHTML = '';
            const isInitiator = currentUser.uid === initiatorId;
            let itemsToShow = isInitiator ? currentItems : currentItems.filter(i => i.signerId === currentUser.uid);
            
            if (itemsToShow.length === 0) {
                els.myItemsList.innerHTML = '<li class="text-xs text-gray-400 italic text-center py-4">ç„¡é …ç›®</li>';
                return;
            }

            itemsToShow.forEach((item, index) => {
                const li = document.createElement('li');
                li.className = 'flex items-center justify-between bg-white p-2 rounded border border-gray-200 shadow-sm';
                let label = item.type === 'signature' ? 'ç°½å' : `æ–‡å­—: ${item.content}`;
                if (isInitiator && item.signerId !== currentUser.uid) label += ' (ä»–äºº)';

                li.innerHTML = `
                    <span class="text-xs font-medium text-gray-700 truncate w-32 cursor-pointer hover:text-brand-600" onclick="focusItem('${item.id}')">${label}</span>
                    <button class="text-red-500 hover:text-red-700 p-1" onclick="deleteItem('${item.id}')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                    </button>
                `;
                els.myItemsList.appendChild(li);
            });
        }
        
        window.deleteItem = async (itemId) => {
            if(confirm('ç¢ºå®šè¦åˆªé™¤æ­¤é …ç›®å—ï¼Ÿ')) {
                await deleteDoc(doc(db, `signing_rooms/${currentRoomId}/items`, itemId));
            }
        };

        window.focusItem = (itemId) => {
            const item = currentItems.find(i => i.id === itemId);
            if(item && !editingItemId && checkDeadline()) {
                openItemEditor(item);
            }
        };

        async function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = e => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        async function renderPdfToImage(file) {
            const buffer = await file.arrayBuffer();
            const pdf = await pdfjsLib.getDocument({ data: buffer }).promise;
            const page = await pdf.getPage(1);
            // æ”¹é€²ï¼šæé«˜è§£æåº¦å€ç‡ (Scale 3.0)
            const viewport = page.getViewport({ scale: 3.0 }); 
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            canvas.height = viewport.height;
            canvas.width = viewport.width;
            await page.render({ canvasContext: context, viewport }).promise;
            return canvas.toDataURL('image/png');
        }
    </script>
</body>
</html>
